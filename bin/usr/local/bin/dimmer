#!/bin/sh

# https://www.stackabuse.com/handling-unix-signals-in-python/

fpeek() {
    head -n 1 "$1"
}

fpush() {
    local fil="$1"
    shift

    if [ -s "$fil" ]; then
        sed -i "1i$*" "$fil"
    else
        echo "$*" > "$fil"
    fi
}

fpop() {
    local fil="$1"
    local val=$(fpeek "$fil")
    sed -i '1d' "$1"
    echo "$val"
}

dim() {
    redshift -P -O "$1" >> /dev/null
    rc=$?
    if [ $rc -eq 0 ]; then
        echo "dimmer: setting screen temp to $DIM"
    else
        echo "dimmer: failed to set screen temp"
    fi
}

DIMMER_FILE=~/.dimmer
TIMEOUT=300
SUNRISE=0600
SUNSET=2100

MAX=4800
MIN=1300

# TODO: use a curve based on time of day and date (number of sunlight hours?)
calculate_dim_value() {
    HOUR=$(date +%H)

    case $HOUR in
        00) DIM=$MIN;;
        01) DIM=$MIN;;
        02) DIM=$MIN;;
        03) DIM=$MIN;;
        04) DIM=$MIN;;
        05) DIM=$MIN;;
        06) DIM=$((MIN+1000));;
        07) DIM=$((MIN+1500));;
        08) DIM=$((MIN+2500));;
        09) DIM=$((MIN+2700));;
        10) DIM=$((MIN+3000));;
        11) DIM=$((MIN+3300));;
        12) DIM=$MAX;;
        13) DIM=$MAX;;
        14) DIM=$MAX;;
        15) DIM=$MAX;;
        16) DIM=$MAX;;
        17) DIM=$((MAX-500));;
        18) DIM=$((MAX-1000));;
        19) DIM=$((MAX-1700));;
        20) DIM=$((MAX-2300));;
        21) DIM=$((MAX-2700));;
        22) DIM=$((MAX-3000));;
        23) DIM=$MIN;;
    esac
}

calculate_dim_value

if [ ! -e $DIMMER_FILE ]; then
    touch $DIMMER_FILE
fi

# run as daemon if told to
if [ "$1" = "daemon" ]; then
    while true; do
        DIM=$(fpeek $DIMMER_FILE)

        if [ -z $DIM ]; then
            calculate_dim_value
        fi

        dim "$DIM"
        sleep $TIMEOUT;
    done
    exit
fi

# parse args and update $DIMMER_FILE
if [ "$1" = "cls" ]; then
    rm $DIMMER_FILE
elif [ "$1" = "pop" ]; then
    fpop $DIMMER_FILE
elif [ "$1" = "ls" ] || [ "$1" = "peek" ]; then
    cat $DIMMER_FILE
    exit 0
elif [ "$1" = "inc" ]; then
    if [ -z "$2" ]; then
        echo "usage: dimmer inc <int>"
        exit 4
    fi
    inc=$2
    val=$(fpeek $DIMMER_FILE)
    if [ -z $val ]; then
        val=$DIM
    fi

    res=$(echo "$val + $inc" | bc)
    fpush $DIMMER_FILE "$res"
elif [ "$1" = "dec" ]; then
    if [ -z "$2" ]; then
        echo "usage: dimmer dec <int>"
        exit 4
    fi
    dec=$2
    val=$(fpeek $DIMMER_FILE)
    if [ -z $val ]; then
        val=$DIM
    fi

    res=$(echo "$val - $dec" | bc)
    fpush $DIMMER_FILE "$res"
elif [ -n "$1" ]; then
    fpop $DIMMER_FILE
    fpush $DIMMER_FILE "$1"
fi

# grab dimming value from $DIMMER_FILE
if [ -s $DIMMER_FILE ]; then
    DIM=$(fpeek $DIMMER_FILE)
fi

if [ -n "$DIM" ]; then
    dim "$DIM"
    exit $rc
fi
