#!/bin/env python

import os
from os.path import expanduser
import sys
import subprocess
from datetime import datetime, timedelta


def notify(msg, level="normal"):
    subprocess.run(["notify-send", "-u", level, msg])


def get_next_target():
    file = expanduser("~/.countdown")
    if os.path.isfile(file):
        with open(file, "r") as f:
            date = f.readline()
            comment_start = date.find("#")
            date = date[:comment_start]
            date = date.strip()

    if date:
        for fmt in ["%Y-%m-%d", "%Y-%m-%d %H:%M"]:
            try:
                return datetime.strptime(date, fmt)
            except ValueError:
                pass


def main():
    now = datetime.now()

    if target := get_next_target():
        diff = target - now

        out = ""

        if diff.total_seconds() < 0:
            notify("countdown complete", "critical")
            out += "-"
            diff = now - target

        days = diff.days
        hours, remainder = divmod(diff.seconds, 3600)
        minutes, seconds = divmod(remainder, 60)

        if days:
            out += f"{days}d "
        if hours:
            out += f"{hours}h "
        if minutes:
            out += f"{minutes}m"

        if days > 30:
            out += f"({days/7:0.0f} weeks)"

        print(out)


if __name__ == "__main__":
    main()
