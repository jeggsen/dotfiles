#!/bin/bash

function fpeek() {
    head -n 1 "$1"
}

function fpush() {
    local fil="$1"
    shift

    if [ -s "$fil" ]; then
        sed -i "1i$*" "$fil"
    else
        echo "$*" > "$fil"
    fi
}

function fpop() {
    local fil="$1"
    local val=$(fpeek "$fil")
    sed -i '1d' "$1"
    echo "$val"
}

DIMMER_FILE=~/.dimmer

HOUR=$(date +%H)
DIM=""

case $HOUR in
    00) DIM=1500;;
    01) DIM=1500;;
    02) DIM=1400;;
    03) DIM=1400;;
    04) DIM=1400;;
    05) DIM=1400;;
    06) DIM=1700;;
    07) DIM=3500;;
    08) DIM=3900;;
    09) DIM=4000;;
    10) DIM=4500;;
    11) DIM=5000;;
    12|13|14) DIM=6500;;
    15) DIM=6000;;
    16) DIM=5400;;
    17) DIM=5000;;
    18) DIM=4900;;
    19) DIM=4800;;
    20) DIM=4500;;
    21) DIM=3850;;
    22) DIM=1900;;
    23) DIM=1500;;
esac

if [ ! -e $DIMMER_FILE ]; then
    touch $DIMMER_FILE
fi

if [ "$1" = "cls" ]; then
    rm $DIMMER_FILE
elif [ "$1" = "pop" ]; then
    fpop $DIMMER_FILE
elif [ "$1" = "ls" ]; then
    cat $DIMMER_FILE
    exit 0
elif [ "$1" = "inc" ]; then
    if [ -z "$2" ]; then
        echo "usage: dimmer inc <int>"
        exit 4
    fi
    inc=$2
    val=$(fpeek $DIMMER_FILE)
    if [ -z $val ]; then
        val=$DIM
    fi

    res=$(echo "$val + $inc" | bc)
    fpush $DIMMER_FILE "$res"
elif [ "$1" = "dec" ]; then
    if [ -z "$2" ]; then
        echo "usage: dimmer dec <int>"
        exit 4
    fi
    dec=$2
    val=$(fpeek $DIMMER_FILE)
    if [ -z $val ]; then
        val=$DIM
    fi

    res=$(echo "$val - $dec" | bc)
    fpush $DIMMER_FILE "$res"
elif [ -n "$1" ]; then
    fpush $DIMMER_FILE "$1"
fi

if [ -s $DIMMER_FILE ]; then
    DIM=$(fpeek $DIMMER_FILE)
fi

if [ -n "$DIM" ]
then
    redshift -P -O "$DIM" >> /dev/null
    rc=$?
    if [ $rc -eq 0 ]; then
        echo "dimmer: setting screen temp to $DIM"
    else
        echo "dimmer: failed to set screen temp"
    fi

    exit $rc
fi
