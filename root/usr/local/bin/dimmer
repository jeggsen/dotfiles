#!/bin/bash

function fpeek() {
    head -n 1 "$1"
}

function fpush() {
    local fil="$1"
    shift

    if [ -s "$fil" ]; then
        sed -i "1i$*" "$fil"
    else
        echo "$*" > "$fil"
    fi
}

function fpop() {
    local fil="$1"
    local val=$(fpeek "$fil")
    sed -i '1d' "$1"
    echo "$val"
}

DIMMER_FILE=~/.dimmer

HOUR=$(date +%H)
DIM=""

MAX=5000
MIN=1300

# TODO: use a curve based on time of day and date (number of sunlight hours?)
case $HOUR in
    00) DIM=$MIN;;
    01) DIM=$MIN;;
    02) DIM=$MIN;;
    03) DIM=$MIN;;
    04) DIM=$MIN;;
    05) DIM=$MIN;;
    06) DIM=2000;;
    07) DIM=2500;;
    08) DIM=3500;;
    09) DIM=4000;;
    10) DIM=$MAX;;
    11) DIM=$MAX;;
    12) DIM=$MAX;;
    13) DIM=$MAX;;
    14) DIM=$MAX;;
    15) DIM=$MAX;;
    16) DIM=4000;;
    17) DIM=3750;;
    18) DIM=3300;;
    19) DIM=2700;;
    20) DIM=2300;;
    21) DIM=2000;;
    22) DIM=1700;;
    23) DIM=$MIN;;
esac

if [ ! -e $DIMMER_FILE ]; then
    touch $DIMMER_FILE
fi

if [ "$1" = "cls" ]; then
    rm $DIMMER_FILE
elif [ "$1" = "pop" ]; then
    fpop $DIMMER_FILE
elif [ "$1" = "ls" ]; then
    cat $DIMMER_FILE
    exit 0
elif [ "$1" = "inc" ]; then
    if [ -z "$2" ]; then
        echo "usage: dimmer inc <int>"
        exit 4
    fi
    inc=$2
    val=$(fpeek $DIMMER_FILE)
    if [ -z $val ]; then
        val=$DIM
    fi

    res=$(echo "$val + $inc" | bc)
    fpush $DIMMER_FILE "$res"
elif [ "$1" = "dec" ]; then
    if [ -z "$2" ]; then
        echo "usage: dimmer dec <int>"
        exit 4
    fi
    dec=$2
    val=$(fpeek $DIMMER_FILE)
    if [ -z $val ]; then
        val=$DIM
    fi

    res=$(echo "$val - $dec" | bc)
    fpush $DIMMER_FILE "$res"
elif [ -n "$1" ]; then
    fpush $DIMMER_FILE "$1"
fi

if [ -s $DIMMER_FILE ]; then
    DIM=$(fpeek $DIMMER_FILE)
fi

if [ -n "$DIM" ]
then
    redshift -P -O "$DIM" >> /dev/null
    rc=$?
    if [ $rc -eq 0 ]; then
        echo "dimmer: setting screen temp to $DIM"
    else
        echo "dimmer: failed to set screen temp"
    fi

    exit $rc
fi
