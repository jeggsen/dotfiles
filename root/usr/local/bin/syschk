#!/bin/bash

good() {
    printf "\e[0;32m[+]\e[m %s\n" "$*"
}

bad() {
    printf "\e[0;31m[-]\e[m %s\n" "$*"
}

chk() {
    test $? -eq 0 && good "$*" || bad "$*"
}

systemd-chk() {
    unit=$1
    shift
    args=$@
    systemctl is-active "$unit" $args &> /dev/null; chk "$unit"
}

proc-chk() {
    pgrep "$1" &> /dev/null; chk "$1"
}

file-age-chk() {
    file=$1
    limit=$2

    last_mod=$(stat -c "%Y" "$file")
    now_epoch=$(date +%s)
    epoch_diff=$(bc <<< "$now_epoch - $last_mod")
    if [ $epoch_diff -gt $limit ]; then
        age=$(stat -c "%y" $file)
        bad "$file last modified $age"
    fi
}

day_in_secs=$(bc <<< "60 * 60 * 24")
week_in_secs=$(bc <<< "$day_in_secs * 7")
month_in_secs=$(bc <<< "$week_in_secs * 4")


systemd-chk "earlyoom"
systemd-chk "dnscrypt-proxy"
systemd-chk "ufw"
systemd-chk "clamav-daemon"
systemd-chk "clamav-freshclam"

proc-chk "sxhkd"
proc-chk "xidlehook"
proc-chk "polybar"
proc-chk "dunst"
proc-chk "tincd"
proc-chk "unclutter"
proc-chk "i3autotile"
proc-chk "autocutsel"

file-age-chk "/etc/hosts" $month_in_secs
