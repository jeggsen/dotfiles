#!/bin/bash

VPNS="$HOME/.vpn"

usage="vpn up <config> | down"

ACTION=$1
case "${ACTION}"
in
    down)
        DOWN=1
        ;;
    up)
        UP=1
        PROFILE=$2
        ;;
esac

get_active_vpn() {
    ACTIVEVPN=$(ip a | \grep -E 'mullvad-[a-z0-9]+' -o | head -n +1) || ACTIVEVPN=0
}

down() {
    get_active_vpn
    [[ -z $ACTIVEVPN ]] && echo "no active vpn found" && exit 1
    sudo wg-quick down "$VPNS/$ACTIVEVPN.conf"
}

up() {
    if [[ -z $PROFILE ]]; then
        PROFILE=$(find "$VPNS" -type f -iname '*.conf' | xargs basename -s '.conf' | sort | fzf) || exit 1
    fi

    # tear down currently active vpn before setting up a new one
    get_active_vpn
    [[ -z $ACTIVEVPN ]] || down

    sudo wg-quick up "$VPNS/$PROFILE.conf"
}

[[ $DOWN ]] && down
[[ $UP ]] && up
